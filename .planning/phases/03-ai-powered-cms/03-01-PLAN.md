---
phase: 03-ai-powered-cms
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/lib/supabase/types.ts
  - supabase/migrations/002_content_cms.sql
  - src/lib/ai/tools.ts
  - src/lib/ai/prompts.ts
  - src/lib/content/queries.ts
  - src/lib/content/mutations.ts
  - src/types/content.ts
  - src/app/admin/api/chat/route.ts
  - src/components/admin/chat-drawer.tsx
  - src/components/admin/chat-message.tsx
  - src/app/admin/layout.tsx
autonomous: true
user_setup:
  - service: anthropic
    why: "AI provider for natural language command processing"
    env_vars:
      - name: ANTHROPIC_API_KEY
        source: "Anthropic Console -> API Keys -> Create key"

must_haves:
  truths:
    - "Admin can access chat interface from admin dashboard"
    - "Admin can type natural language commands in chat"
    - "AI understands and responds to content update requests"
    - "AI can update text content in database"
    - "AI can add/update/remove announcement bar"
    - "AI can toggle section visibility"
    - "Chat history persists across browser sessions"
  artifacts:
    - path: "supabase/migrations/002_content_cms.sql"
      provides: "Database schema for content, announcements, visibility, chat history"
      contains: "CREATE TABLE site_content"
    - path: "src/lib/ai/tools.ts"
      provides: "AI tool definitions for content operations"
      exports: ["updateTextContentTool", "updateAnnouncementBarTool", "toggleSectionVisibilityTool"]
    - path: "src/app/admin/api/chat/route.ts"
      provides: "Streaming chat API endpoint"
      exports: ["POST"]
    - path: "src/components/admin/chat-drawer.tsx"
      provides: "Bottom drawer chat UI component"
      min_lines: 80
  key_links:
    - from: "src/components/admin/chat-drawer.tsx"
      to: "/admin/api/chat"
      via: "useChat hook"
      pattern: "useChat.*api.*chat"
    - from: "src/app/admin/api/chat/route.ts"
      to: "src/lib/ai/tools.ts"
      via: "tool imports"
      pattern: "import.*tools"
    - from: "src/lib/ai/tools.ts"
      to: "src/lib/content/mutations.ts"
      via: "database operations"
      pattern: "createDraft|updateContent"
---

<objective>
Build AI-powered content management infrastructure and chat interface

Purpose: Enable non-technical administrators to update website content using natural language commands through a conversational chat interface in the admin panel.

Output:
- Database schema for editable content, announcements, section visibility, and chat history
- AI SDK integration with Anthropic Claude for natural language understanding
- Tool definitions for content operations (text, announcement bar, visibility)
- Bottom drawer chat interface with message persistence
- Admin can immediately start using chat to update content
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-ai-powered-cms/03-CONTEXT.md
@.planning/phases/03-ai-powered-cms/03-RESEARCH.md

# Existing admin infrastructure
@src/app/admin/layout.tsx
@src/app/admin/dashboard/page.tsx
@src/lib/supabase/server.ts
@src/lib/supabase/types.ts

# Content to make editable
@src/components/sections/hero-section.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database schema and AI SDK setup</name>
  <files>
    supabase/migrations/002_content_cms.sql
    package.json
    src/lib/supabase/types.ts
    src/types/content.ts
    .env.local.example
  </files>
  <action>
Create database migration for AI CMS:

**supabase/migrations/002_content_cms.sql:**
```sql
-- Site content storage (text fields, descriptions, etc.)
CREATE TABLE site_content (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  content_key TEXT UNIQUE NOT NULL,
  content_type TEXT NOT NULL DEFAULT 'text',
  content JSONB NOT NULL,
  page TEXT,
  section TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Content drafts for preview before publishing
CREATE TABLE content_drafts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  content_key TEXT NOT NULL,
  draft_type TEXT NOT NULL,
  content JSONB NOT NULL,
  created_by UUID REFERENCES auth.users(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  expires_at TIMESTAMPTZ DEFAULT NOW() + INTERVAL '1 hour'
);

-- Version history (auto-populated by trigger)
CREATE TABLE content_versions (
  id BIGSERIAL PRIMARY KEY,
  content_key TEXT NOT NULL,
  content JSONB NOT NULL,
  changed_by UUID,
  changed_at TIMESTAMPTZ DEFAULT NOW(),
  change_description TEXT
);

-- Trigger function for auto-versioning
CREATE OR REPLACE FUNCTION version_content()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO content_versions (content_key, content, changed_by, change_description)
  VALUES (
    OLD.content_key,
    OLD.content,
    auth.uid(),
    'Auto-versioned on update'
  );

  -- Keep only last 10 versions per content_key
  DELETE FROM content_versions
  WHERE id IN (
    SELECT id FROM content_versions
    WHERE content_key = OLD.content_key
    ORDER BY changed_at DESC
    OFFSET 10
  );

  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE TRIGGER content_version_trigger
BEFORE UPDATE ON site_content
FOR EACH ROW
EXECUTE FUNCTION version_content();

-- Announcement bar
CREATE TABLE announcement_bar (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  text TEXT NOT NULL,
  link_url TEXT,
  link_text TEXT,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Section visibility toggles
CREATE TABLE section_visibility (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  section_key TEXT UNIQUE NOT NULL,
  is_visible BOOLEAN DEFAULT true,
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Chat message history
CREATE TABLE chat_messages (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id),
  role TEXT NOT NULL CHECK (role IN ('user', 'assistant')),
  content TEXT NOT NULL,
  tool_calls JSONB,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Indexes
CREATE INDEX idx_site_content_key ON site_content(content_key);
CREATE INDEX idx_content_versions_key ON content_versions(content_key, changed_at DESC);
CREATE INDEX idx_chat_messages_user ON chat_messages(user_id, created_at DESC);
CREATE INDEX idx_content_drafts_expires ON content_drafts(expires_at);

-- Seed initial editable content from current hardcoded values
INSERT INTO site_content (content_key, content_type, content, page, section) VALUES
  ('hero.headline', 'text', '{"text": "BUILDING CHAMPIONS ON AND OFF THE FIELD"}', 'homepage', 'hero'),
  ('hero.subtitle', 'text', '{"text": "Youth football programs for ages 5-14. Building character, discipline, and teamwork through the game we love."}', 'homepage', 'hero'),
  ('hero.cta_primary', 'text', '{"text": "Register Now"}', 'homepage', 'hero'),
  ('hero.cta_secondary', 'text', '{"text": "Learn More"}', 'homepage', 'hero');

-- RLS policies
ALTER TABLE site_content ENABLE ROW LEVEL SECURITY;
ALTER TABLE content_drafts ENABLE ROW LEVEL SECURITY;
ALTER TABLE content_versions ENABLE ROW LEVEL SECURITY;
ALTER TABLE announcement_bar ENABLE ROW LEVEL SECURITY;
ALTER TABLE section_visibility ENABLE ROW LEVEL SECURITY;
ALTER TABLE chat_messages ENABLE ROW LEVEL SECURITY;

-- Public can read published content
CREATE POLICY "Public can read site_content" ON site_content FOR SELECT USING (true);
CREATE POLICY "Public can read announcement_bar" ON announcement_bar FOR SELECT USING (is_active = true);
CREATE POLICY "Public can read section_visibility" ON section_visibility FOR SELECT USING (true);

-- Authenticated users can modify (admin check in application layer)
CREATE POLICY "Authenticated can all site_content" ON site_content FOR ALL USING (auth.role() = 'authenticated');
CREATE POLICY "Authenticated can all content_drafts" ON content_drafts FOR ALL USING (auth.role() = 'authenticated');
CREATE POLICY "Authenticated can all content_versions" ON content_versions FOR ALL USING (auth.role() = 'authenticated');
CREATE POLICY "Authenticated can all announcement_bar" ON announcement_bar FOR ALL USING (auth.role() = 'authenticated');
CREATE POLICY "Authenticated can all section_visibility" ON section_visibility FOR ALL USING (auth.role() = 'authenticated');
CREATE POLICY "Users can access own chat_messages" ON chat_messages FOR ALL USING (auth.uid() = user_id);
```

**Install AI SDK:**
```bash
npm install ai @ai-sdk/react @ai-sdk/anthropic
```

**Update src/lib/supabase/types.ts** - Add new tables to Database type:
- site_content (id, content_key, content_type, content JSONB, page, section, timestamps)
- content_drafts (id, content_key, draft_type, content JSONB, created_by, timestamps, expires_at)
- content_versions (id BIGSERIAL, content_key, content JSONB, changed_by, changed_at, change_description)
- announcement_bar (id, text, link_url, link_text, is_active, timestamps)
- section_visibility (id, section_key, is_visible, updated_at)
- chat_messages (id, user_id, role, content, tool_calls JSONB, created_at)

**Create src/types/content.ts** - Export types:
- ContentKey type (union of valid keys: 'hero.headline' | 'hero.subtitle' | 'hero.cta_primary' | 'hero.cta_secondary')
- SiteContent interface
- ContentDraft interface
- AnnouncementBar interface
- SectionVisibility interface

**Update .env.local.example** - Add:
```
ANTHROPIC_API_KEY=your_anthropic_api_key_here
```
  </action>
  <verify>
    npm run build succeeds with no type errors
    Migration file exists at supabase/migrations/002_content_cms.sql
    package.json includes ai, @ai-sdk/react, @ai-sdk/anthropic
  </verify>
  <done>
    Database schema ready for content CMS
    AI SDK packages installed
    TypeScript types defined for all content tables
  </done>
</task>

<task type="auto">
  <name>Task 2: AI tools and content operations</name>
  <files>
    src/lib/ai/tools.ts
    src/lib/ai/prompts.ts
    src/lib/content/queries.ts
    src/lib/content/mutations.ts
  </files>
  <action>
**Create src/lib/ai/prompts.ts:**

Export SYSTEM_PROMPT constant with:
- Role: helpful assistant for RiseUp Youth Football website
- Capabilities: update text content, manage announcement bar, toggle section visibility
- Available content keys with descriptions:
  - hero.headline: Main headline on homepage
  - hero.subtitle: Subtitle text below headline
  - hero.cta_primary: Primary button text
  - hero.cta_secondary: Secondary button text
- Guidelines: be conversational, ask clarifying questions when ambiguous with numbered options, explain limitations when asked for unsupported actions
- Example interactions showing good responses

**Create src/lib/content/queries.ts:**

Export functions:
- `getContent(contentKey: string): Promise<string>` - Fetch from site_content, return content.text or fallback to DEFAULT_CONTENT
- `getSectionVisibility(sectionKey: string): Promise<boolean>` - Fetch from section_visibility, default true
- `getAnnouncementBar(): Promise<AnnouncementBar | null>` - Fetch active announcement
- `getChatHistory(userId: string, limit?: number): Promise<ChatMessage[]>` - Fetch user's chat messages

Include DEFAULT_CONTENT object with hardcoded fallbacks matching current hero-section.tsx values.

**Create src/lib/content/mutations.ts:**

Export functions:
- `createDraft(contentKey: string, draftType: string, content: object, userId: string): Promise<{id: string}>` - Insert into content_drafts
- `publishDraft(draftId: string): Promise<void>` - Copy draft to site_content, delete draft, revalidatePath
- `cancelDraft(draftId: string): Promise<void>` - Delete draft
- `updateAnnouncementBar(action: 'add' | 'update' | 'remove', data?: {text: string, linkUrl?: string, linkText?: string}): Promise<{draftId: string}>` - Create announcement draft
- `toggleSectionVisibility(sectionKey: string, visible: boolean): Promise<{draftId: string}>` - Create visibility draft
- `saveChatMessage(userId: string, role: 'user' | 'assistant', content: string, toolCalls?: object): Promise<void>` - Save to chat_messages

**Create src/lib/ai/tools.ts:**

Import { tool } from 'ai' and { z } from 'zod'.

Export tools:

1. `updateTextContentTool` - tool({
   description: 'Update a text content field on the website...',
   parameters: z.object({
     contentKey: z.enum(['hero.headline', 'hero.subtitle', 'hero.cta_primary', 'hero.cta_secondary']).describe('The content field to update'),
     newText: z.string().describe('The new text content')
   }),
   execute: async ({ contentKey, newText }) => {
     // Create draft, return { success, draftId, previewUrl, message }
   }
})

2. `updateAnnouncementBarTool` - tool({
   description: 'Add, update, or remove the announcement bar...',
   parameters: z.object({
     action: z.enum(['add', 'update', 'remove']),
     text: z.string().optional(),
     linkUrl: z.string().optional(),
     linkText: z.string().optional()
   }),
   execute: async ({ action, text, linkUrl, linkText }) => {
     // Create draft, return { success, draftId, previewUrl, message }
   }
})

3. `toggleSectionVisibilityTool` - tool({
   description: 'Show or hide a section on the website',
   parameters: z.object({
     sectionKey: z.string().describe('The section to toggle'),
     visible: z.boolean()
   }),
   execute: async ({ sectionKey, visible }) => {
     // Create draft, return { success, draftId, previewUrl, message }
   }
})

4. `listEditableContentTool` - tool({
   description: 'List all content that can be edited',
   parameters: z.object({}),
   execute: async () => {
     // Return list of content keys with current values
   }
})

Note: Tool execute functions should NOT use needsApproval since we're implementing custom preview flow. Tools create drafts and return preview URLs.
  </action>
  <verify>
    npm run build succeeds
    src/lib/ai/tools.ts exports all four tools
    src/lib/ai/prompts.ts exports SYSTEM_PROMPT
    src/lib/content/queries.ts and mutations.ts exist with expected exports
  </verify>
  <done>
    AI tool definitions ready for content operations
    Content query/mutation functions ready for database operations
    System prompt defines AI behavior and available content keys
  </done>
</task>

<task type="auto">
  <name>Task 3: Chat API route and UI components</name>
  <files>
    src/app/admin/api/chat/route.ts
    src/components/admin/chat-drawer.tsx
    src/components/admin/chat-message.tsx
    src/app/admin/layout.tsx
  </files>
  <action>
**Create src/app/admin/api/chat/route.ts:**

```typescript
import { streamText } from 'ai';
import { anthropic } from '@ai-sdk/anthropic';
import { createClient } from '@/lib/supabase/server';
import { SYSTEM_PROMPT } from '@/lib/ai/prompts';
import {
  updateTextContentTool,
  updateAnnouncementBarTool,
  toggleSectionVisibilityTool,
  listEditableContentTool
} from '@/lib/ai/tools';

export async function POST(req: Request) {
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();

  if (!user) {
    return new Response('Unauthorized', { status: 401 });
  }

  const { messages } = await req.json();

  const result = streamText({
    model: anthropic('claude-sonnet-4-20250514'),
    system: SYSTEM_PROMPT,
    messages,
    tools: {
      updateTextContent: updateTextContentTool,
      updateAnnouncementBar: updateAnnouncementBarTool,
      toggleSectionVisibility: toggleSectionVisibilityTool,
      listEditableContent: listEditableContentTool,
    },
  });

  return result.toDataStreamResponse();
}
```

**Create src/components/admin/chat-message.tsx:**

Client component that renders a single chat message.
- Props: message (from useChat), onPreview (callback for preview button)
- Render user messages with right-aligned style
- Render assistant messages with left-aligned style
- If message contains tool result with previewUrl, show "Preview Changes" button
- Use Tailwind for styling matching admin dark theme

**Create src/components/admin/chat-drawer.tsx:**

'use client' component with:
- State: isOpen (boolean), controlled by toggle button
- useChat hook from @ai-sdk/react with api: '/admin/api/chat'
- Load initial messages from getChatHistory on mount (via server action or API)
- First-visit detection via localStorage for onboarding examples
- AnimatePresence + motion.div for bottom drawer animation (framer-motion)
- Height: 50vh when open, animates from 0
- Fixed positioning at bottom of screen
- Message list with auto-scroll to bottom
- Input form at bottom with submit handler
- Show example commands on first visit when no messages
- Styling: bg-black/95, border-t border-white/10, consistent with admin theme

Example commands to show:
- "Change the hero headline to Registration Now Open"
- "Add an announcement about summer camp registration"
- "What content can I edit?"

**Update src/app/admin/layout.tsx:**

- Import ChatDrawer component
- Add ChatDrawer at the bottom of the layout (after main content)
- Add "Content Editor" link to admin nav pointing to chat toggle
- Or add a floating button to open chat drawer
  </action>
  <verify>
    npm run build succeeds
    Admin layout includes ChatDrawer component
    Visiting /admin/dashboard shows chat toggle/button
    Chat drawer animates open and closed
  </verify>
  <done>
    Chat API endpoint accepts messages and streams responses
    Chat drawer UI renders in admin panel
    Messages display with proper styling
    Admin can type commands and receive AI responses
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Database setup:** Run migration in Supabase SQL Editor
2. **Build check:** `npm run build` passes without errors
3. **Chat access:** Navigate to /admin/dashboard, chat interface is visible
4. **Command test:** Type "What can I edit?" - AI should list available content
5. **Update test:** Type "Change the hero headline to Test" - AI should create draft and provide preview URL
</verification>

<success_criteria>
- AI SDK packages installed (ai, @ai-sdk/react, @ai-sdk/anthropic)
- Database migration creates all required tables
- Chat drawer opens/closes with animation in admin panel
- Admin can send messages and receive streaming AI responses
- AI correctly identifies content update requests
- Draft system creates entries for preview (preview page in Plan 02)
- Chat history persists in database
</success_criteria>

<output>
After completion, create `.planning/phases/03-ai-powered-cms/03-01-SUMMARY.md`
</output>
