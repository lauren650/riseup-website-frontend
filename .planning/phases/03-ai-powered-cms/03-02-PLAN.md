---
phase: 03-ai-powered-cms
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/app/admin/dashboard/preview/page.tsx
  - src/app/admin/dashboard/history/page.tsx
  - src/lib/actions/content.ts
  - src/components/admin/preview-bar.tsx
  - src/components/admin/history-table.tsx
  - src/components/sections/hero-section.tsx
  - src/components/layout/announcement-bar.tsx
  - src/app/(public)/layout.tsx
  - src/app/admin/layout.tsx
autonomous: false

must_haves:
  truths:
    - "Admin sees full page preview with changes highlighted before publishing"
    - "Admin can click Publish to apply changes or Cancel to discard"
    - "Admin can view history of last 10 content changes"
    - "Admin can preview any historical version"
    - "Admin can rollback to any of the last 10 versions"
    - "All content changes are logged with timestamp and user"
    - "Announcement bar displays on public site when active"
    - "Hero section reads content from database with fallback"
  artifacts:
    - path: "src/app/admin/dashboard/preview/page.tsx"
      provides: "Full page preview with publish/cancel actions"
      min_lines: 60
    - path: "src/app/admin/dashboard/history/page.tsx"
      provides: "Change history list with rollback capability"
      min_lines: 50
    - path: "src/lib/actions/content.ts"
      provides: "Server actions for publish, cancel, rollback"
      exports: ["publishDraft", "cancelDraft", "rollbackToVersion"]
    - path: "src/components/layout/announcement-bar.tsx"
      provides: "Announcement bar component for public pages"
      min_lines: 20
  key_links:
    - from: "src/app/admin/dashboard/preview/page.tsx"
      to: "src/lib/actions/content.ts"
      via: "server action form"
      pattern: "action=.publishDraft"
    - from: "src/components/sections/hero-section.tsx"
      to: "src/lib/content/queries.ts"
      via: "getContent calls"
      pattern: "getContent.*hero"
    - from: "src/app/(public)/layout.tsx"
      to: "src/components/layout/announcement-bar.tsx"
      via: "component import"
      pattern: "AnnouncementBar"
---

<objective>
Build preview system, version history, and rollback functionality

Purpose: Complete the AI CMS by enabling admins to preview changes before publishing, view change history, and rollback to previous versions. Also wire up the public site to display database-driven content.

Output:
- Preview page showing full site with highlighted changes
- Publish/Cancel actions on preview
- History page listing last 10 changes per content key
- Rollback functionality to restore previous versions
- Announcement bar component integrated into public layout
- Hero section updated to read from database
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-ai-powered-cms/03-CONTEXT.md
@.planning/phases/03-ai-powered-cms/03-RESEARCH.md

# From Plan 01
@.planning/phases/03-ai-powered-cms/03-01-SUMMARY.md

# Existing files to modify
@src/components/sections/hero-section.tsx
@src/app/(public)/layout.tsx
@src/app/admin/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Preview page with publish/cancel actions</name>
  <files>
    src/app/admin/dashboard/preview/page.tsx
    src/components/admin/preview-bar.tsx
    src/lib/actions/content.ts
  </files>
  <action>
**Create src/lib/actions/content.ts:**

'use server' module with server actions:

```typescript
'use server';

import { createClient } from '@/lib/supabase/server';
import { revalidatePath } from 'next/cache';
import { redirect } from 'next/navigation';

export async function publishDraft(formData: FormData) {
  const draftId = formData.get('draftId') as string;
  const supabase = await createClient();

  // Verify user is authenticated
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) throw new Error('Unauthorized');

  // Get draft
  const { data: draft, error: draftError } = await supabase
    .from('content_drafts')
    .select('*')
    .eq('id', draftId)
    .single();

  if (draftError || !draft) throw new Error('Draft not found');

  // Handle different draft types
  if (draft.draft_type === 'text') {
    // Upsert to site_content
    await supabase
      .from('site_content')
      .upsert({
        content_key: draft.content_key,
        content: draft.content,
        content_type: 'text',
        updated_at: new Date().toISOString()
      }, { onConflict: 'content_key' });
  } else if (draft.draft_type === 'announcement') {
    // Handle announcement bar
    const action = draft.content.action;
    if (action === 'add' || action === 'update') {
      await supabase.from('announcement_bar').upsert({
        id: draft.content.id || undefined,
        text: draft.content.text,
        link_url: draft.content.linkUrl,
        link_text: draft.content.linkText,
        is_active: true,
        updated_at: new Date().toISOString()
      });
    } else if (action === 'remove') {
      await supabase.from('announcement_bar').update({ is_active: false }).eq('is_active', true);
    }
  } else if (draft.draft_type === 'visibility') {
    await supabase
      .from('section_visibility')
      .upsert({
        section_key: draft.content_key,
        is_visible: draft.content.visible,
        updated_at: new Date().toISOString()
      }, { onConflict: 'section_key' });
  }

  // Delete the draft
  await supabase.from('content_drafts').delete().eq('id', draftId);

  // Revalidate affected pages
  revalidatePath('/');
  revalidatePath('/about');
  revalidatePath('/flag-football');
  revalidatePath('/tackle-football');
  revalidatePath('/academies-clinics');

  redirect('/admin/dashboard?published=true');
}

export async function cancelDraft(formData: FormData) {
  const draftId = formData.get('draftId') as string;
  const supabase = await createClient();

  const { data: { user } } = await supabase.auth.getUser();
  if (!user) throw new Error('Unauthorized');

  await supabase.from('content_drafts').delete().eq('id', draftId);

  redirect('/admin/dashboard?cancelled=true');
}

export async function rollbackToVersion(formData: FormData) {
  const versionId = formData.get('versionId') as string;
  const supabase = await createClient();

  const { data: { user } } = await supabase.auth.getUser();
  if (!user) throw new Error('Unauthorized');

  // Get the version
  const { data: version } = await supabase
    .from('content_versions')
    .select('*')
    .eq('id', versionId)
    .single();

  if (!version) throw new Error('Version not found');

  // Update current content (trigger will auto-version current state)
  await supabase
    .from('site_content')
    .update({
      content: version.content,
      updated_at: new Date().toISOString()
    })
    .eq('content_key', version.content_key);

  revalidatePath('/');
  redirect('/admin/dashboard/history?restored=true');
}
```

**Create src/components/admin/preview-bar.tsx:**

Client component showing preview status bar:
- Fixed position at top of viewport (z-50)
- Amber/yellow background to indicate preview mode
- Text: "Preview Mode - Changes not yet published"
- Two forms side by side:
  - Publish form with green button, hidden draftId input
  - Cancel form with subtle button, hidden draftId input
- Props: draftId (string)

**Create src/app/admin/dashboard/preview/page.tsx:**

Server component that:
1. Verifies user authentication (redirect to login if not)
2. Reads ?draft=UUID from searchParams
3. Fetches draft from content_drafts table
4. If draft not found, redirect to /admin/dashboard
5. Fetches current content for context
6. Renders:
   - PreviewBar with draftId
   - iframe showing the affected page with ?preview=draftId query param
   - OR: Import the page component and render with draft content overlaid

For iframe approach:
```tsx
<div className="pt-16"> {/* Space for preview bar */}
  <iframe
    src={`${getPreviewPageUrl(draft.content_key)}?preview=${draft.id}`}
    className="w-full h-[calc(100vh-4rem)] border-0"
  />
</div>
```

For component approach:
- Pass draft content as prop
- Render page with CSS highlight on changed element (ring-2 ring-amber-500 animate-pulse)
  </action>
  <verify>
    npm run build succeeds
    Navigate to /admin/dashboard/preview?draft=invalid shows redirect
    src/lib/actions/content.ts exports publishDraft, cancelDraft, rollbackToVersion
  </verify>
  <done>
    Preview page renders full page with proposed changes
    Publish action commits draft to database
    Cancel action discards draft
    Preview bar shows clear status and action buttons
  </done>
</task>

<task type="auto">
  <name>Task 2: History page and rollback</name>
  <files>
    src/app/admin/dashboard/history/page.tsx
    src/components/admin/history-table.tsx
    src/app/admin/layout.tsx
  </files>
  <action>
**Create src/components/admin/history-table.tsx:**

Server component displaying version history:
- Props: versions (array from content_versions table)
- Table layout with columns:
  - Date/Time (formatted nicely, e.g., "Jan 18, 2026 at 3:45 PM")
  - Content Key (e.g., "hero.headline")
  - Preview of old value (truncated to 50 chars)
  - Actions: "Preview" link and "Restore" button
- Empty state when no versions
- Styled with admin dark theme (border-white/10, bg-white/5)

**Create src/app/admin/dashboard/history/page.tsx:**

Server component that:
1. Verifies user authentication
2. Fetches all versions from content_versions grouped by content_key, ordered by changed_at DESC
3. Limits to 10 most recent per content_key
4. If ?restored=true in searchParams, show success toast/message
5. Renders:
   - Page title "Change History"
   - Filter dropdown to filter by content_key (optional, can default to all)
   - HistoryTable component with versions
   - Each row has Restore form with hidden versionId, calls rollbackToVersion action

For restore preview:
- "Preview" link goes to special route or modal showing what the content looked like
- Simple approach: just show the content.text value in a modal/dialog
- Advanced approach: render in iframe with that version's content

**Update src/app/admin/layout.tsx:**

Add "History" link to admin navigation:
```tsx
<Link
  href="/admin/dashboard/history"
  className="text-sm text-muted-foreground transition-colors hover:text-white"
>
  History
</Link>
```
  </action>
  <verify>
    npm run build succeeds
    Navigate to /admin/dashboard/history shows history page
    History link appears in admin navigation
    Restore button triggers rollbackToVersion action
  </verify>
  <done>
    History page displays last 10 versions per content key
    Admin can view what content looked like at any version
    Restore action rolls back content to selected version
    Navigation includes History link
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire public site to database content</name>
  <files>
    src/components/sections/hero-section.tsx
    src/components/layout/announcement-bar.tsx
    src/app/(public)/layout.tsx
  </files>
  <action>
**Create src/components/layout/announcement-bar.tsx:**

Async server component:
```typescript
import { createClient } from '@/lib/supabase/server';

export async function AnnouncementBar() {
  const supabase = await createClient();

  const { data: announcement } = await supabase
    .from('announcement_bar')
    .select('*')
    .eq('is_active', true)
    .single();

  if (!announcement) return null;

  return (
    <div className="bg-accent text-white py-2 px-4 text-center text-sm">
      <span>{announcement.text}</span>
      {announcement.link_url && (
        <a
          href={announcement.link_url}
          className="ml-2 underline hover:no-underline font-medium"
        >
          {announcement.link_text || 'Learn more'}
        </a>
      )}
    </div>
  );
}
```

**Update src/app/(public)/layout.tsx:**

Add AnnouncementBar at the top of the layout, before the header:
```tsx
import { AnnouncementBar } from '@/components/layout/announcement-bar';

export default function PublicLayout({ children }) {
  return (
    <>
      <AnnouncementBar />
      <Header />
      <main>{children}</main>
      <Footer />
    </>
  );
}
```

**Update src/components/sections/hero-section.tsx:**

Convert to async server component that fetches content:
```typescript
import { createClient } from '@/lib/supabase/server';
import { VideoHero } from '@/components/ui/video-hero';
import { Button } from '@/components/ui/button';

// Fallback content when database not seeded
const DEFAULTS = {
  'hero.headline': 'BUILDING CHAMPIONS ON AND OFF THE FIELD',
  'hero.subtitle': 'Youth football programs for ages 5-14. Building character, discipline, and teamwork through the game we love.',
  'hero.cta_primary': 'Register Now',
  'hero.cta_secondary': 'Learn More',
};

async function getContent(supabase: any, key: string): Promise<string> {
  const { data } = await supabase
    .from('site_content')
    .select('content')
    .eq('content_key', key)
    .single();

  return data?.content?.text || DEFAULTS[key] || '';
}

export async function HeroSection() {
  const supabase = await createClient();

  const [headline, subtitle, ctaPrimary, ctaSecondary] = await Promise.all([
    getContent(supabase, 'hero.headline'),
    getContent(supabase, 'hero.subtitle'),
    getContent(supabase, 'hero.cta_primary'),
    getContent(supabase, 'hero.cta_secondary'),
  ]);

  return (
    <VideoHero
      videoSrc="/videos/hero.mp4"
      posterSrc="/images/hero-poster.jpg"
    >
      <div className="text-center max-w-4xl mx-auto">
        <h1 className="text-4xl md:text-5xl lg:text-6xl font-bold text-white tracking-tight mb-6">
          {headline}
        </h1>
        <p className="text-lg md:text-xl text-white/80 mb-10 max-w-2xl mx-auto">
          {subtitle}
        </p>
        <div className="flex flex-col sm:flex-row gap-4 justify-center">
          <Button
            variant="primary"
            size="lg"
            href="https://riseupyouthfootball.com/register"
          >
            {ctaPrimary}
          </Button>
          <Button
            variant="outline"
            size="lg"
            href="#programs"
          >
            {ctaSecondary}
          </Button>
        </div>
      </div>
    </VideoHero>
  );
}
```
  </action>
  <verify>
    npm run build succeeds
    Homepage still renders correctly (with fallback content)
    If database seeded with different content, homepage shows database values
  </verify>
  <done>
    Hero section reads content from database with graceful fallback
    Announcement bar displays when active in database
    Public site renders database-driven content
    Changes via AI chat reflect on public site after publish
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 4: Verify complete AI CMS workflow</name>
  <what-built>
    Complete AI-powered content management system:
    - Chat interface for natural language commands
    - Preview before publishing
    - Version history with rollback
    - Database-driven content on public site
  </what-built>
  <how-to-verify>
    **Prerequisites:**
    1. Run migration 002_content_cms.sql in Supabase SQL Editor
    2. Add ANTHROPIC_API_KEY to .env.local
    3. Start dev server: npm run dev

    **Test the full workflow:**

    1. **Access admin panel:**
       - Go to http://localhost:3000/admin/login
       - Log in with your admin credentials
       - Verify chat interface is available (bottom drawer or button)

    2. **Test AI content editing:**
       - Open chat drawer
       - Type: "What content can I edit?"
       - Verify AI lists available content keys
       - Type: "Change the hero headline to Registration Opens March 1st"
       - Verify AI responds with preview URL

    3. **Test preview and publish:**
       - Click the preview link from AI response
       - Verify full page preview shows with amber bar at top
       - Verify the hero headline shows the new text
       - Click "Publish" button
       - Verify redirect to dashboard with success

    4. **Verify public site updated:**
       - Open http://localhost:3000 in new tab
       - Verify hero headline now says "Registration Opens March 1st"

    5. **Test announcement bar:**
       - In chat: "Add an announcement saying Summer camp registration now open"
       - Preview and publish
       - Verify announcement bar appears at top of public site

    6. **Test history and rollback:**
       - Go to /admin/dashboard/history
       - Verify previous headline version is listed
       - Click "Restore" on the old version
       - Verify public site shows original headline again

    **Expected result:** Non-technical admin can update any text content, manage announcements, and rollback changes - all through natural language commands.
  </how-to-verify>
  <resume-signal>Type "approved" if workflow works, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Build passes:** `npm run build` succeeds
2. **Preview works:** Drafts show in preview mode with publish/cancel
3. **History works:** Past versions listed, rollback functions
4. **Public content dynamic:** Hero reads from database
5. **Announcement bar:** Displays when active
6. **Full workflow:** Chat -> Preview -> Publish -> See change on site
</verification>

<success_criteria>
- Preview page shows full site with proposed changes
- Publish commits changes to database
- Cancel discards draft
- History page lists last 10 versions per content key
- Rollback restores selected version
- Public site hero reads from database
- Announcement bar component works
- Complete chat-to-publish workflow functional
</success_criteria>

<output>
After completion, create `.planning/phases/03-ai-powered-cms/03-02-SUMMARY.md`
</output>
