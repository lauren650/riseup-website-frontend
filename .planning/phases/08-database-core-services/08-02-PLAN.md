# Plan 08-02: Google Drive & Sheets Integration

**Phase:** 8 - Database & Core Services
**Created:** 2026-01-23
**Depends on:** Plan 08-01

---

## Goal

Build Google Drive and Google Sheets service clients with authentication, folder management, and spreadsheet operations.

---

## Success Criteria

- [x] `googleapis` package installed
- [x] Service account authentication configured
- [x] Google Drive client can create folders and upload files
- [x] Google Sheets client can create spreadsheet and append/update rows
- [x] Environment variables documented
- [x] Type-safe client interfaces
- [x] Error handling and retry logic

---

## Tasks

### 1. Install Dependencies

```bash
npm install googleapis
npm install --save-dev @types/node
```

### 2. Create Google Drive Client

**File:** `/src/lib/google-drive.ts`

```typescript
import { google } from 'googleapis';

// Initialize Drive client with service account
function getDriveClient() {
  const auth = new google.auth.GoogleAuth({
    credentials: {
      client_email: process.env.GOOGLE_SERVICE_ACCOUNT_EMAIL,
      private_key: process.env.GOOGLE_PRIVATE_KEY?.replace(/\\n/g, '\n'),
    },
    scopes: ['https://www.googleapis.com/auth/drive.file'],
  });

  return google.drive({ version: 'v3', auth });
}

/**
 * Creates a folder in Google Drive
 * @param folderName - Name of the folder
 * @param parentFolderId - Parent folder ID (optional, defaults to root sponsor folder)
 * @returns Folder ID
 */
export async function createDriveFolder(
  folderName: string,
  parentFolderId?: string
): Promise<string> {
  const drive = getDriveClient();
  const rootFolderId = process.env.GOOGLE_DRIVE_ROOT_FOLDER_ID;

  const fileMetadata = {
    name: folderName,
    mimeType: 'application/vnd.google-apps.folder',
    parents: [parentFolderId || rootFolderId],
  };

  try {
    const response = await drive.files.create({
      requestBody: fileMetadata,
      fields: 'id',
    });

    if (!response.data.id) {
      throw new Error('Failed to create folder: No ID returned');
    }

    return response.data.id;
  } catch (error) {
    console.error('Error creating Drive folder:', error);
    throw new Error(`Failed to create Drive folder: ${folderName}`);
  }
}

/**
 * Uploads a file to Google Drive
 * @param fileName - Name for the file
 * @param fileBuffer - File contents as Buffer
 * @param mimeType - MIME type of the file
 * @param parentFolderId - Folder to upload to
 * @returns File ID
 */
export async function uploadFileToDrive(
  fileName: string,
  fileBuffer: Buffer,
  mimeType: string,
  parentFolderId: string
): Promise<string> {
  const drive = getDriveClient();

  const fileMetadata = {
    name: fileName,
    parents: [parentFolderId],
  };

  try {
    const response = await drive.files.create({
      requestBody: fileMetadata,
      media: {
        mimeType,
        body: fileBuffer,
      },
      fields: 'id',
    });

    if (!response.data.id) {
      throw new Error('Failed to upload file: No ID returned');
    }

    return response.data.id;
  } catch (error) {
    console.error('Error uploading file to Drive:', error);
    throw new Error(`Failed to upload file: ${fileName}`);
  }
}

/**
 * Gets the package folder ID, creating it if it doesn't exist
 * @param packageName - Name of the sponsorship package
 * @returns Package folder ID
 */
export async function getOrCreatePackageFolder(
  packageName: string
): Promise<string> {
  const drive = getDriveClient();
  const rootFolderId = process.env.GOOGLE_DRIVE_ROOT_FOLDER_ID;

  // Search for existing folder
  try {
    const response = await drive.files.list({
      q: `name='${packageName}' and '${rootFolderId}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`,
      fields: 'files(id, name)',
      spaces: 'drive',
    });

    // If found, return existing folder ID
    if (response.data.files && response.data.files.length > 0) {
      return response.data.files[0].id!;
    }

    // If not found, create new folder
    return await createDriveFolder(packageName, rootFolderId);
  } catch (error) {
    console.error('Error getting/creating package folder:', error);
    throw new Error(`Failed to manage package folder: ${packageName}`);
  }
}

/**
 * Creates a sponsor-specific folder within a package folder
 * @param companyName - Name of the company
 * @param invoiceId - Stripe invoice ID
 * @param packageFolderId - Parent package folder ID
 * @returns Sponsor folder ID
 */
export async function createSponsorFolder(
  companyName: string,
  invoiceId: string,
  packageFolderId: string
): Promise<string> {
  const folderName = `${companyName} - ${invoiceId}`;
  return await createDriveFolder(folderName, packageFolderId);
}

/**
 * Gets a public URL for a Drive file (requires file to be shared)
 * Note: This returns a Drive URL, not a direct download link
 * @param fileId - Drive file ID
 * @returns Public Drive URL
 */
export function getDriveFileUrl(fileId: string): string {
  return `https://drive.google.com/file/d/${fileId}/view`;
}
```

### 3. Create Google Sheets Client

**File:** `/src/lib/google-sheets.ts`

```typescript
import { google } from 'googleapis';

// Initialize Sheets client with service account
function getSheetsClient() {
  const auth = new google.auth.GoogleAuth({
    credentials: {
      client_email: process.env.GOOGLE_SERVICE_ACCOUNT_EMAIL,
      private_key: process.env.GOOGLE_PRIVATE_KEY?.replace(/\\n/g, '\n'),
    },
    scopes: ['https://www.googleapis.com/auth/spreadsheets'],
  });

  return google.sheets({ version: 'v4', auth });
}

/**
 * Sponsor row data for Google Sheets
 */
export interface SponsorSheetRow {
  companyName: string;
  packageName: string;
  invoiceId: string;
  amount: number;
  paymentDate?: string; // ISO date string
  uploadStatus: 'Pending' | 'Completed';
  driveFolderUrl?: string;
  websiteUrl?: string;
  createdDate: string; // ISO date string
}

/**
 * Creates the master sponsor tracking spreadsheet
 * @returns Spreadsheet ID
 */
export async function createSponsorSpreadsheet(): Promise<string> {
  const sheets = getSheetsClient();

  const spreadsheet = {
    properties: {
      title: 'RiseUp Sponsor Tracking',
    },
    sheets: [
      {
        properties: {
          title: 'Sponsors',
        },
        data: [
          {
            startRow: 0,
            startColumn: 0,
            rowData: [
              {
                values: [
                  { userEnteredValue: { stringValue: 'Company Name' } },
                  { userEnteredValue: { stringValue: 'Package' } },
                  { userEnteredValue: { stringValue: 'Invoice ID' } },
                  { userEnteredValue: { stringValue: 'Amount' } },
                  { userEnteredValue: { stringValue: 'Payment Date' } },
                  { userEnteredValue: { stringValue: 'Upload Status' } },
                  { userEnteredValue: { stringValue: 'Drive Folder' } },
                  { userEnteredValue: { stringValue: 'Website URL' } },
                  { userEnteredValue: { stringValue: 'Created Date' } },
                ],
              },
            ],
          },
        ],
      },
    ],
  };

  try {
    const response = await sheets.spreadsheets.create({
      requestBody: spreadsheet,
    });

    if (!response.data.spreadsheetId) {
      throw new Error('Failed to create spreadsheet: No ID returned');
    }

    // Format header row
    await sheets.spreadsheets.batchUpdate({
      spreadsheetId: response.data.spreadsheetId,
      requestBody: {
        requests: [
          {
            repeatCell: {
              range: {
                sheetId: 0,
                startRowIndex: 0,
                endRowIndex: 1,
              },
              cell: {
                userEnteredFormat: {
                  backgroundColor: { red: 0.0, green: 0.0, blue: 0.0 },
                  textFormat: {
                    foregroundColor: { red: 1.0, green: 1.0, blue: 1.0 },
                    fontSize: 12,
                    bold: true,
                  },
                },
              },
              fields: 'userEnteredFormat(backgroundColor,textFormat)',
            },
          },
        ],
      },
    });

    console.log('Created spreadsheet:', response.data.spreadsheetUrl);
    return response.data.spreadsheetId;
  } catch (error) {
    console.error('Error creating spreadsheet:', error);
    throw new Error('Failed to create sponsor tracking spreadsheet');
  }
}

/**
 * Appends a new sponsor row to the spreadsheet
 * @param data - Sponsor row data
 * @returns Row index (1-based, excluding header)
 */
export async function appendSponsorRow(data: SponsorSheetRow): Promise<number> {
  const sheets = getSheetsClient();
  const spreadsheetId = process.env.GOOGLE_SHEETS_SPREADSHEET_ID;

  if (!spreadsheetId) {
    throw new Error('GOOGLE_SHEETS_SPREADSHEET_ID not configured');
  }

  const values = [
    [
      data.companyName,
      data.packageName,
      data.invoiceId,
      `$${(data.amount / 100).toFixed(2)}`,
      data.paymentDate || '',
      data.uploadStatus,
      data.driveFolderUrl || '',
      data.websiteUrl || '',
      data.createdDate,
    ],
  ];

  try {
    const response = await sheets.spreadsheets.values.append({
      spreadsheetId,
      range: 'Sponsors!A2', // Start after header
      valueInputOption: 'USER_ENTERED',
      requestBody: { values },
    });

    // Extract row number from updates
    const updatedRange = response.data.updates?.updatedRange || '';
    const rowMatch = updatedRange.match(/!A(\d+)/);
    const rowIndex = rowMatch ? parseInt(rowMatch[1]) : 0;

    return rowIndex;
  } catch (error) {
    console.error('Error appending to spreadsheet:', error);
    throw new Error('Failed to append sponsor row to spreadsheet');
  }
}

/**
 * Updates an existing sponsor row in the spreadsheet
 * @param rowIndex - Row number (1-based, excluding header)
 * @param updates - Partial row data to update
 */
export async function updateSponsorRow(
  rowIndex: number,
  updates: Partial<SponsorSheetRow>
): Promise<void> {
  const sheets = getSheetsClient();
  const spreadsheetId = process.env.GOOGLE_SHEETS_SPREADSHEET_ID;

  if (!spreadsheetId) {
    throw new Error('GOOGLE_SHEETS_SPREADSHEET_ID not configured');
  }

  // Build values array with only updated fields
  const values: (string | number | undefined)[] = [];
  const columnMap = {
    companyName: 0,
    packageName: 1,
    invoiceId: 2,
    amount: 3,
    paymentDate: 4,
    uploadStatus: 5,
    driveFolderUrl: 6,
    websiteUrl: 7,
    createdDate: 8,
  };

  // Get existing row first
  try {
    const existing = await sheets.spreadsheets.values.get({
      spreadsheetId,
      range: `Sponsors!A${rowIndex}:I${rowIndex}`,
    });

    const existingValues = existing.data.values?.[0] || [];

    // Update specific columns
    if (updates.paymentDate !== undefined) {
      existingValues[columnMap.paymentDate] = updates.paymentDate;
    }
    if (updates.uploadStatus !== undefined) {
      existingValues[columnMap.uploadStatus] = updates.uploadStatus;
    }
    if (updates.driveFolderUrl !== undefined) {
      existingValues[columnMap.driveFolderUrl] = updates.driveFolderUrl;
    }
    if (updates.websiteUrl !== undefined) {
      existingValues[columnMap.websiteUrl] = updates.websiteUrl;
    }

    await sheets.spreadsheets.values.update({
      spreadsheetId,
      range: `Sponsors!A${rowIndex}:I${rowIndex}`,
      valueInputOption: 'USER_ENTERED',
      requestBody: {
        values: [existingValues],
      },
    });
  } catch (error) {
    console.error('Error updating spreadsheet row:', error);
    throw new Error(`Failed to update row ${rowIndex} in spreadsheet`);
  }
}

/**
 * Finds a row index by invoice ID
 * @param invoiceId - Stripe invoice ID to search for
 * @returns Row index (1-based) or null if not found
 */
export async function findRowByInvoiceId(
  invoiceId: string
): Promise<number | null> {
  const sheets = getSheetsClient();
  const spreadsheetId = process.env.GOOGLE_SHEETS_SPREADSHEET_ID;

  if (!spreadsheetId) {
    throw new Error('GOOGLE_SHEETS_SPREADSHEET_ID not configured');
  }

  try {
    const response = await sheets.spreadsheets.values.get({
      spreadsheetId,
      range: 'Sponsors!C2:C', // Invoice ID column, starting after header
    });

    const values = response.data.values || [];
    const rowIndex = values.findIndex((row) => row[0] === invoiceId);

    // Convert to 1-based index, accounting for header row
    return rowIndex >= 0 ? rowIndex + 2 : null;
  } catch (error) {
    console.error('Error finding row in spreadsheet:', error);
    return null;
  }
}
```

### 4. Update Environment Variables

**File:** `.env.local` (add to `.env.example` too)

```bash
# Google Service Account (for automated Drive/Sheets access)
GOOGLE_SERVICE_ACCOUNT_EMAIL=
GOOGLE_PRIVATE_KEY=

# Google Drive folder for sponsor uploads
GOOGLE_DRIVE_ROOT_FOLDER_ID=

# Google Sheets for sponsor tracking
GOOGLE_SHEETS_SPREADSHEET_ID=
```

**File:** `.env.example` (documentation)

```bash
# =============================================================================
# GOOGLE APIS - Service Account Authentication
# =============================================================================
# Required for automated sponsor upload workflow (Drive + Sheets)
#
# Setup Steps:
# 1. Create Google Cloud project: https://console.cloud.google.com
# 2. Enable Google Drive API and Google Sheets API
# 3. Create service account: IAM & Admin > Service Accounts
# 4. Download service account key (JSON file)
# 5. Extract client_email and private_key from JSON
# 6. Create "RiseUp Sponsors" folder in Google Drive
# 7. Share folder with service account email (Editor access)
# 8. Get folder ID from URL: https://drive.google.com/drive/folders/{FOLDER_ID}
# 9. Create tracking spreadsheet (auto-created by setup script)
# 10. Share spreadsheet with service account email (Editor access)

GOOGLE_SERVICE_ACCOUNT_EMAIL=your-service-account@project-id.iam.gserviceaccount.com
GOOGLE_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\nYOUR_PRIVATE_KEY_HERE\n-----END PRIVATE KEY-----\n"
GOOGLE_DRIVE_ROOT_FOLDER_ID=1abc123xyz456
GOOGLE_SHEETS_SPREADSHEET_ID=1def789uvw321
```

### 5. Create Type Definitions

**File:** `/src/lib/types/google-integrations.ts`

```typescript
export interface GoogleDriveFolder {
  id: string;
  name: string;
  parentId: string;
}

export interface GoogleDriveFile {
  id: string;
  name: string;
  mimeType: string;
  folderId: string;
}

export interface SponsorUploadWorkflow {
  invoiceId: string;
  companyName: string;
  packageName: string;
  packageId: string;
  amount: number;
  driveFolderId: string;
  uploadToken: string;
  tokenExpiresAt: Date;
}
```

---

## Files Created

- `/src/lib/google-drive.ts` - Drive client with folder/file operations
- `/src/lib/google-sheets.ts` - Sheets client with append/update operations
- `/src/lib/types/google-integrations.ts` - Type definitions
- `.env.example` - Updated with Google API configuration

---

## Testing

Test each function independently before integration:

```typescript
// Test Drive authentication and folder creation
import { createDriveFolder, getOrCreatePackageFolder } from '@/lib/google-drive';

const folderId = await createDriveFolder('Test Folder');
console.log('Created folder:', folderId);

const packageId = await getOrCreatePackageFolder('Championship Package');
console.log('Package folder:', packageId);

// Test Sheets operations
import { createSponsorSpreadsheet, appendSponsorRow } from '@/lib/google-sheets';

const spreadsheetId = await createSponsorSpreadsheet();
console.log('Created spreadsheet:', spreadsheetId);

const rowIndex = await appendSponsorRow({
  companyName: 'Test Company',
  packageName: 'Test Package',
  invoiceId: 'inv_test123',
  amount: 350000,
  uploadStatus: 'Pending',
  createdDate: new Date().toISOString().split('T')[0],
});
console.log('Appended row:', rowIndex);
```

---

## Next Steps

After this plan completes:
- Plan 08-03: Setup validation script and documentation

---

*Plan created: 2026-01-23*
