# Plan 08-03: Setup Validation & Documentation

**Phase:** 8 - Database & Core Services
**Created:** 2026-01-23
**Depends on:** Plan 08-01, Plan 08-02

---

## Goal

Create setup validation script to test Google API connections and comprehensive documentation for service account configuration.

---

## Success Criteria

- [x] Setup validation script tests all Google API operations
- [x] Script provides clear success/failure messages
- [x] Admin can run script to verify configuration before proceeding
- [x] Documentation covers complete service account setup process
- [x] README updated with Phase 8 setup instructions

---

## Tasks

### 1. Create Setup Validation Script

**File:** `/scripts/validate-google-setup.ts`

```typescript
#!/usr/bin/env tsx

/**
 * Validation script for Google Drive and Sheets integration
 * Run after setting up service account to verify configuration
 * 
 * Usage: npm run validate:google
 */

import { google } from 'googleapis';
import {
  createDriveFolder,
  getOrCreatePackageFolder,
  uploadFileToDrive,
} from '@/lib/google-drive';
import {
  createSponsorSpreadsheet,
  appendSponsorRow,
  updateSponsorRow,
  findRowByInvoiceId,
} from '@/lib/google-sheets';

// ANSI color codes for terminal output
const colors = {
  reset: '\x1b[0m',
  green: '\x1b[32m',
  red: '\x1b[31m',
  yellow: '\x1b[33m',
  blue: '\x1b[34m',
  bold: '\x1b[1m',
};

function log(message: string, color: string = colors.reset) {
  console.log(`${color}${message}${colors.reset}`);
}

function success(message: string) {
  log(`✓ ${message}`, colors.green);
}

function error(message: string) {
  log(`✗ ${message}`, colors.red);
}

function warning(message: string) {
  log(`⚠ ${message}`, colors.yellow);
}

function info(message: string) {
  log(`ℹ ${message}`, colors.blue);
}

function header(message: string) {
  log(`\n${colors.bold}${message}${colors.reset}`);
}

async function validateEnvironmentVariables(): Promise<boolean> {
  header('1. Validating Environment Variables');

  const required = [
    'GOOGLE_SERVICE_ACCOUNT_EMAIL',
    'GOOGLE_PRIVATE_KEY',
    'GOOGLE_DRIVE_ROOT_FOLDER_ID',
  ];

  let allPresent = true;

  for (const key of required) {
    if (process.env[key]) {
      success(`${key} is set`);
    } else {
      error(`${key} is missing`);
      allPresent = false;
    }
  }

  // GOOGLE_SHEETS_SPREADSHEET_ID is optional (created by this script if missing)
  if (process.env.GOOGLE_SHEETS_SPREADSHEET_ID) {
    success('GOOGLE_SHEETS_SPREADSHEET_ID is set');
  } else {
    warning('GOOGLE_SHEETS_SPREADSHEET_ID not set (will be created)');
  }

  return allPresent;
}

async function validateDriveAuthentication(): Promise<boolean> {
  header('2. Testing Google Drive Authentication');

  try {
    const auth = new google.auth.GoogleAuth({
      credentials: {
        client_email: process.env.GOOGLE_SERVICE_ACCOUNT_EMAIL,
        private_key: process.env.GOOGLE_PRIVATE_KEY?.replace(/\\n/g, '\n'),
      },
      scopes: ['https://www.googleapis.com/auth/drive.file'],
    });

    const drive = google.drive({ version: 'v3', auth });

    // Test access to root folder
    const rootFolderId = process.env.GOOGLE_DRIVE_ROOT_FOLDER_ID;
    const response = await drive.files.get({
      fileId: rootFolderId!,
      fields: 'id, name, mimeType',
    });

    success('Successfully authenticated with Google Drive API');
    info(`Root folder: ${response.data.name} (${response.data.id})`);

    return true;
  } catch (err: any) {
    error('Failed to authenticate with Google Drive API');
    error(err.message);
    return false;
  }
}

async function validateDriveFolderOperations(): Promise<boolean> {
  header('3. Testing Google Drive Folder Operations');

  try {
    // Test creating a test folder
    const testFolderName = `TEST-${Date.now()}`;
    info(`Creating test folder: ${testFolderName}`);

    const folderId = await createDriveFolder(testFolderName);
    success(`Created test folder: ${folderId}`);

    // Test package folder creation
    info('Testing package folder creation...');
    const packageFolderId = await getOrCreatePackageFolder('Championship Package');
    success(`Package folder ready: ${packageFolderId}`);

    return true;
  } catch (err: any) {
    error('Failed to create folders in Google Drive');
    error(err.message);
    return false;
  }
}

async function validateDriveFileUpload(): Promise<boolean> {
  header('4. Testing Google Drive File Upload');

  try {
    // Create a test file buffer
    const testContent = 'RiseUp Google Drive Integration Test';
    const testBuffer = Buffer.from(testContent, 'utf-8');

    // Get package folder
    const packageFolderId = await getOrCreatePackageFolder('Championship Package');

    // Upload test file
    const testFileName = `test-${Date.now()}.txt`;
    info(`Uploading test file: ${testFileName}`);

    const fileId = await uploadFileToDrive(
      testFileName,
      testBuffer,
      'text/plain',
      packageFolderId
    );

    success(`Uploaded test file: ${fileId}`);
    info(`View at: https://drive.google.com/file/d/${fileId}/view`);

    return true;
  } catch (err: any) {
    error('Failed to upload file to Google Drive');
    error(err.message);
    return false;
  }
}

async function validateSheetsAuthentication(): Promise<boolean> {
  header('5. Testing Google Sheets Authentication');

  try {
    const auth = new google.auth.GoogleAuth({
      credentials: {
        client_email: process.env.GOOGLE_SERVICE_ACCOUNT_EMAIL,
        private_key: process.env.GOOGLE_PRIVATE_KEY?.replace(/\\n/g, '\n'),
      },
      scopes: ['https://www.googleapis.com/auth/spreadsheets'],
    });

    const sheets = google.sheets({ version: 'v4', auth });

    // If spreadsheet ID exists, test access
    if (process.env.GOOGLE_SHEETS_SPREADSHEET_ID) {
      const response = await sheets.spreadsheets.get({
        spreadsheetId: process.env.GOOGLE_SHEETS_SPREADSHEET_ID,
      });

      success('Successfully authenticated with Google Sheets API');
      info(`Spreadsheet: ${response.data.properties?.title}`);
      info(`URL: ${response.data.spreadsheetUrl}`);
    } else {
      // Create new spreadsheet
      info('No spreadsheet configured, creating new one...');
      const spreadsheetId = await createSponsorSpreadsheet();

      success('Successfully created sponsor tracking spreadsheet');
      info(`Spreadsheet ID: ${spreadsheetId}`);
      warning('Add this to your .env.local as GOOGLE_SHEETS_SPREADSHEET_ID');
    }

    return true;
  } catch (err: any) {
    error('Failed to authenticate with Google Sheets API');
    error(err.message);
    return false;
  }
}

async function validateSheetsOperations(): Promise<boolean> {
  header('6. Testing Google Sheets Operations');

  if (!process.env.GOOGLE_SHEETS_SPREADSHEET_ID) {
    warning('Skipping Sheets operations test (no spreadsheet ID)');
    return true;
  }

  try {
    // Test append
    const testInvoiceId = `test_inv_${Date.now()}`;
    info(`Appending test row with invoice: ${testInvoiceId}`);

    const rowIndex = await appendSponsorRow({
      companyName: 'Test Company',
      packageName: 'Test Package',
      invoiceId: testInvoiceId,
      amount: 350000,
      uploadStatus: 'Pending',
      createdDate: new Date().toISOString().split('T')[0],
    });

    success(`Appended row at index: ${rowIndex}`);

    // Test find
    info('Testing row lookup by invoice ID...');
    const foundIndex = await findRowByInvoiceId(testInvoiceId);

    if (foundIndex === rowIndex) {
      success(`Found row at correct index: ${foundIndex}`);
    } else {
      error(`Row mismatch: expected ${rowIndex}, found ${foundIndex}`);
      return false;
    }

    // Test update
    info('Testing row update...');
    await updateSponsorRow(rowIndex, {
      paymentDate: new Date().toISOString().split('T')[0],
      uploadStatus: 'Completed',
      websiteUrl: 'https://test.com',
    });

    success('Successfully updated row');

    return true;
  } catch (err: any) {
    error('Failed to perform Sheets operations');
    error(err.message);
    return false;
  }
}

async function main() {
  log(`${colors.bold}${colors.blue}
╔═══════════════════════════════════════════════════════╗
║   RiseUp Google Integration Validation               ║
║   Testing Drive & Sheets Service Account Setup       ║
╚═══════════════════════════════════════════════════════╝
${colors.reset}`);

  const tests = [
    { name: 'Environment Variables', fn: validateEnvironmentVariables },
    { name: 'Drive Authentication', fn: validateDriveAuthentication },
    { name: 'Drive Folder Operations', fn: validateDriveFolderOperations },
    { name: 'Drive File Upload', fn: validateDriveFileUpload },
    { name: 'Sheets Authentication', fn: validateSheetsAuthentication },
    { name: 'Sheets Operations', fn: validateSheetsOperations },
  ];

  const results: boolean[] = [];

  for (const test of tests) {
    const passed = await test.fn();
    results.push(passed);

    if (!passed) {
      warning(`Stopping at failed test: ${test.name}`);
      break;
    }
  }

  // Summary
  header('Validation Summary');

  const passed = results.filter((r) => r).length;
  const total = results.length;

  if (passed === total) {
    success(`All ${total} tests passed! ✨`);
    info('Your Google integration is ready to use.');
    process.exit(0);
  } else {
    error(`${passed}/${total} tests passed`);
    warning('Please fix the errors above and run again.');
    process.exit(1);
  }
}

// Run validation
main().catch((err) => {
  error(`Unexpected error: ${err.message}`);
  process.exit(1);
});
```

### 2. Add NPM Script

**File:** `package.json` (add script)

```json
{
  "scripts": {
    "validate:google": "tsx scripts/validate-google-setup.ts"
  }
}
```

### 3. Create Setup Guide

**File:** `/docs/GOOGLE_SETUP_GUIDE.md`

```markdown
# Google Drive & Sheets Integration Setup Guide

This guide walks through setting up Google Cloud service account for automated sponsor upload workflow.

---

## Overview

The RiseUp sponsor management system uses Google Drive to store sponsor logos and Google Sheets to track sponsorship status. This integration requires a Google Cloud service account with API access.

**What you'll need:**
- Google Cloud account (free tier is sufficient)
- Google Drive account
- About 15 minutes

---

## Step 1: Create Google Cloud Project

1. Go to [Google Cloud Console](https://console.cloud.google.com)
2. Click **Create Project**
3. Name it "RiseUp Website" (or similar)
4. Click **Create**
5. Wait for project to be created (~30 seconds)

---

## Step 2: Enable APIs

1. In Google Cloud Console, go to **APIs & Services** > **Library**
2. Search for "Google Drive API"
3. Click **Enable**
4. Go back to Library
5. Search for "Google Sheets API"
6. Click **Enable**

---

## Step 3: Create Service Account

1. Go to **IAM & Admin** > **Service Accounts**
2. Click **Create Service Account**
3. Name: `riseup-sponsor-automation`
4. Description: "Automated sponsor upload workflow"
5. Click **Create and Continue**
6. Skip role assignment (we'll use folder-level permissions)
7. Click **Done**

---

## Step 4: Create Service Account Key

1. Click on the service account you just created
2. Go to **Keys** tab
3. Click **Add Key** > **Create new key**
4. Choose **JSON** format
5. Click **Create**
6. Save the downloaded JSON file securely (NEVER commit to git!)

---

## Step 5: Extract Credentials

Open the downloaded JSON file. You need two values:

```json
{
  "client_email": "riseup-sponsor-automation@project-id.iam.gserviceaccount.com",
  "private_key": "-----BEGIN PRIVATE KEY-----\nMIIE...\n-----END PRIVATE KEY-----\n"
}
```

Copy these to your `.env.local`:

```bash
GOOGLE_SERVICE_ACCOUNT_EMAIL=riseup-sponsor-automation@project-id.iam.gserviceaccount.com
GOOGLE_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\nYOUR_KEY_HERE\n-----END PRIVATE KEY-----\n"
```

**Important:** The private key MUST include `\n` characters for line breaks.

---

## Step 6: Create Google Drive Folder

1. Go to [Google Drive](https://drive.google.com)
2. Create a new folder named "RiseUp Sponsors"
3. Right-click folder > **Share**
4. Add your service account email (from Step 5)
5. Give it **Editor** access
6. Click **Share**

Get the folder ID from the URL:
```
https://drive.google.com/drive/folders/1abc123xyz456
                                          ↑ This is the ID
```

Add to `.env.local`:
```bash
GOOGLE_DRIVE_ROOT_FOLDER_ID=1abc123xyz456
```

---

## Step 7: Create Google Sheets Spreadsheet

**Option A: Let the setup script create it** (recommended)
- Run validation script (Step 8) and it will create the spreadsheet
- Add the generated ID to `.env.local`

**Option B: Create manually**
1. Go to [Google Sheets](https://sheets.google.com)
2. Create new spreadsheet named "RiseUp Sponsor Tracking"
3. Right-click > **Share**
4. Add service account email with **Editor** access
5. Get spreadsheet ID from URL:
   ```
   https://docs.google.com/spreadsheets/d/1def789uvw321/edit
                                           ↑ This is the ID
   ```
6. Add to `.env.local`:
   ```bash
   GOOGLE_SHEETS_SPREADSHEET_ID=1def789uvw321
   ```

---

## Step 8: Validate Setup

Run the validation script to test all connections:

```bash
npm run validate:google
```

**Expected output:**
```
✓ GOOGLE_SERVICE_ACCOUNT_EMAIL is set
✓ GOOGLE_PRIVATE_KEY is set
✓ GOOGLE_DRIVE_ROOT_FOLDER_ID is set
✓ Successfully authenticated with Google Drive API
✓ Created test folder
✓ Package folder ready
✓ Uploaded test file
✓ Successfully authenticated with Google Sheets API
✓ Appended test row
✓ All 6 tests passed! ✨
```

If any tests fail, check:
- Service account email has access to Drive folder
- Service account email has access to Spreadsheet
- Private key includes proper `\n` line breaks
- Folder/Spreadsheet IDs are correct

---

## Troubleshooting

### "Failed to authenticate with Google Drive API"
- Verify `GOOGLE_SERVICE_ACCOUNT_EMAIL` matches JSON file
- Check `GOOGLE_PRIVATE_KEY` includes `\n` characters
- Ensure Drive API is enabled in Google Cloud Console

### "Failed to create folders in Google Drive"
- Service account needs **Editor** access to root folder
- Check `GOOGLE_DRIVE_ROOT_FOLDER_ID` is correct
- Verify folder exists and is not in trash

### "Failed to authenticate with Google Sheets API"
- Ensure Sheets API is enabled in Google Cloud Console
- Service account needs **Editor** access to spreadsheet
- Check `GOOGLE_SHEETS_SPREADSHEET_ID` is correct

### "ENOENT: no such file or directory" when running validation
- Run `npm install` to ensure all dependencies installed
- Make sure you're in project root directory

---

## Security Best Practices

✅ **DO:**
- Store credentials in `.env.local` (never committed)
- Use service account (not personal OAuth)
- Limit service account to specific folder/spreadsheet
- Rotate service account keys annually

❌ **DON'T:**
- Commit `.env.local` or service account JSON to git
- Share service account credentials publicly
- Use personal Google account credentials
- Give service account access to entire Drive

---

## Next Steps

After successful validation:
1. Phase 9: Build invoice management UI
2. Phase 10: Enhance payment webhook to trigger uploads
3. Phase 11: Build sponsor upload form

---

*Last updated: 2026-01-23*
```

### 4. Update Main README

**File:** `README.md` (add section)

```markdown
## Google APIs Setup (Phase 8+)

Required for sponsor upload workflow (v1.2+):

1. Follow [Google Setup Guide](docs/GOOGLE_SETUP_GUIDE.md)
2. Add credentials to `.env.local`
3. Run validation: `npm run validate:google`

See [`docs/GOOGLE_SETUP_GUIDE.md`](docs/GOOGLE_SETUP_GUIDE.md) for detailed instructions.
```

### 5. Update .gitignore

Ensure sensitive files are never committed:

**File:** `.gitignore` (verify these lines exist)

```
# Environment variables
.env.local
.env*.local

# Google service account keys
*-service-account.json
google-credentials.json
```

---

## Files Created

- `/scripts/validate-google-setup.ts` - Validation script
- `/docs/GOOGLE_SETUP_GUIDE.md` - Setup documentation
- `package.json` - Updated with validation script
- `README.md` - Updated with Google setup reference

---

## Testing

Run the validation script:

```bash
npm run validate:google
```

Expected behavior:
- ✓ All tests pass if properly configured
- ✗ Clear error messages if misconfigured
- Creates test folders/files in Drive
- Creates/updates test rows in Sheets
- Shows spreadsheet ID if created

---

## Phase 8 Completion Checklist

- [ ] Database migration applied (006_sponsor_uploads.sql)
- [ ] Package benefit flags working
- [ ] Google Drive client functional
- [ ] Google Sheets client functional
- [ ] Validation script passes all tests
- [ ] Documentation complete
- [ ] Environment variables configured
- [ ] Service account has proper permissions

---

*Plan created: 2026-01-23*
