# Plan 08-01: Database Schema & Package Benefits

**Phase:** 8 - Database & Core Services
**Created:** 2026-01-23
**Depends on:** Phase 5

---

## Goal

Create database migration for sponsor uploads tracking and add flexible package benefits system to sponsorship_packages table.

---

## Success Criteria

- [x] Migration file `006_sponsor_uploads.sql` created
- [x] `sponsor_uploads` table exists with all required columns
- [x] `sponsorship_packages` table has benefit flag columns
- [x] Existing seed data updated with appropriate benefit flags
- [x] RLS policies configured for sponsor_uploads
- [x] Indexes created for performance
- [x] Migration runs successfully on local Supabase

---

## Tasks

### 1. Create Migration File

**File:** `/supabase/migrations/006_sponsor_uploads.sql`

**Contents:**

```sql
-- Migration: 006_sponsor_uploads
-- Description: Create sponsor_uploads table and add benefit flags to sponsorship_packages
-- Created: 2026-01-23

-- ============================================================================
-- ALTER SPONSORSHIP PACKAGES - ADD BENEFIT FLAGS
-- ============================================================================
-- Add flexible benefit tracking to packages (checkbox system)

ALTER TABLE sponsorship_packages
ADD COLUMN IF NOT EXISTS includes_website_benefit BOOLEAN DEFAULT false,
ADD COLUMN IF NOT EXISTS includes_banner BOOLEAN DEFAULT false,
ADD COLUMN IF NOT EXISTS includes_tshirt BOOLEAN DEFAULT false,
ADD COLUMN IF NOT EXISTS includes_golf_sign BOOLEAN DEFAULT false,
ADD COLUMN IF NOT EXISTS includes_game_day BOOLEAN DEFAULT false,
ADD COLUMN IF NOT EXISTS description TEXT;

-- Update existing seed data with appropriate benefits
UPDATE sponsorship_packages
SET 
  includes_website_benefit = true,
  includes_tshirt = true,
  includes_banner = true,
  includes_golf_sign = true,
  description = 'Complete package with maximum visibility across all RiseUp events and platforms'
WHERE name = 'T-shirt (tackle & flag), website, banner, golf tournament sign';

UPDATE sponsorship_packages
SET 
  includes_website_benefit = true,
  description = 'Your logo displayed on our Partners page with link to your website'
WHERE name = 'Website only logo';

UPDATE sponsorship_packages
SET 
  includes_game_day = true,
  description = 'Prominent presence at game day events with booth space'
WHERE name = 'Game day package';

UPDATE sponsorship_packages
SET 
  includes_tshirt = true,
  description = 'Your logo featured on Rise Up Academy training shirts'
WHERE name = 'Rise Up Academy t-shirt';

-- ============================================================================
-- SPONSOR UPLOADS TABLE
-- ============================================================================
-- Tracks upload tokens, status, and links uploads to invoices

CREATE TABLE IF NOT EXISTS sponsor_uploads (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  invoice_id UUID REFERENCES invoices(id) ON DELETE CASCADE NOT NULL,
  upload_token TEXT UNIQUE NOT NULL,
  company_name TEXT NOT NULL,
  package_id UUID REFERENCES sponsorship_packages(id) ON DELETE RESTRICT NOT NULL,
  
  -- Upload data
  logo_url TEXT, -- Supabase Storage URL (cached from Drive)
  website_url TEXT,
  drive_folder_id TEXT NOT NULL, -- Created on invoice payment
  drive_file_id TEXT, -- Populated after upload
  sheets_row_index INTEGER, -- Row number in Google Sheets (for updates)
  
  -- Status tracking
  status TEXT NOT NULL DEFAULT 'pending' CHECK (status IN ('pending', 'completed', 'expired')),
  uploaded_at TIMESTAMPTZ,
  
  -- Token security
  token_expires_at TIMESTAMPTZ NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  
  CONSTRAINT token_not_expired CHECK (token_expires_at > created_at)
);

-- ============================================================================
-- ROW LEVEL SECURITY POLICIES
-- ============================================================================

ALTER TABLE sponsor_uploads ENABLE ROW LEVEL SECURITY;

-- Public can SELECT by valid token (for upload form access)
CREATE POLICY "Anyone can view upload by token"
ON sponsor_uploads FOR SELECT
USING (
  upload_token IS NOT NULL 
  AND status = 'pending' 
  AND token_expires_at > NOW()
);

-- Public can UPDATE by valid token (for upload form submission)
CREATE POLICY "Anyone can update upload by valid token"
ON sponsor_uploads FOR UPDATE
USING (
  upload_token IS NOT NULL 
  AND status = 'pending' 
  AND token_expires_at > NOW()
);

-- Authenticated users (admins) can view all
CREATE POLICY "Authenticated users can view all uploads"
ON sponsor_uploads FOR SELECT
TO authenticated
USING (true);

-- Service role can INSERT (created by webhook after payment)
-- Note: Service role bypasses RLS, so no explicit policy needed

-- ============================================================================
-- INDEXES
-- ============================================================================

-- Upload token lookup (primary access pattern for public form)
CREATE INDEX IF NOT EXISTS idx_sponsor_uploads_token
ON sponsor_uploads(upload_token);

-- Invoice relationship
CREATE INDEX IF NOT EXISTS idx_sponsor_uploads_invoice_id
ON sponsor_uploads(invoice_id);

-- Status filtering (dashboard queries)
CREATE INDEX IF NOT EXISTS idx_sponsor_uploads_status
ON sponsor_uploads(status);

-- Package relationship
CREATE INDEX IF NOT EXISTS idx_sponsor_uploads_package_id
ON sponsor_uploads(package_id);

-- ============================================================================
-- TRIGGERS
-- ============================================================================

-- Reuse existing update_updated_at_column() function
CREATE TRIGGER update_sponsor_uploads_updated_at
  BEFORE UPDATE ON sponsor_uploads
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

-- ============================================================================
-- COMMENTS
-- ============================================================================

COMMENT ON TABLE sponsor_uploads IS 'Tracks sponsor upload workflow after invoice payment. Each paid invoice generates one upload token.';
COMMENT ON COLUMN sponsor_uploads.upload_token IS 'Secure UUID for public upload form access (90-day expiration)';
COMMENT ON COLUMN sponsor_uploads.drive_folder_id IS 'Google Drive folder ID created on invoice payment';
COMMENT ON COLUMN sponsor_uploads.logo_url IS 'Supabase Storage URL - cached copy of logo from Drive for fast public access';
COMMENT ON COLUMN sponsor_uploads.sheets_row_index IS 'Row number in Google Sheets for efficient updates';
```

### 2. Run Migration

```bash
# Apply migration to local Supabase
npx supabase migration up

# Verify tables
npx supabase db inspect
```

### 3. Update TypeScript Types

**File:** `/src/lib/database.types.ts` (regenerate)

```bash
# Generate types from database schema
npx supabase gen types typescript --local > src/lib/database.types.ts
```

### 4. Create Validation Functions

**File:** `/src/lib/validations/sponsor-upload.ts`

```typescript
import { z } from 'zod';

export const sponsorUploadSchema = z.object({
  logo: z
    .instanceof(File)
    .refine((file) => file.size <= 2 * 1024 * 1024, 'Logo must be less than 2MB')
    .refine(
      (file) => ['image/png', 'image/jpeg', 'image/svg+xml'].includes(file.type),
      'Logo must be PNG, JPG, or SVG'
    ),
  website_url: z
    .string()
    .url('Must be a valid URL')
    .min(1, 'Website URL is required')
    .refine(
      (url) => url.startsWith('http://') || url.startsWith('https://'),
      'URL must start with http:// or https://'
    ),
});

export type SponsorUploadInput = z.infer<typeof sponsorUploadSchema>;
```

---

## Files Created

- `/supabase/migrations/006_sponsor_uploads.sql` - Database migration
- `/src/lib/validations/sponsor-upload.ts` - Upload form validation
- `/src/lib/database.types.ts` - Updated type definitions

---

## Testing

### Verification Checklist

```bash
# 1. Migration applied successfully
npx supabase migration list

# 2. Tables exist
npx supabase db diff

# 3. Check package benefits
psql -h localhost -U postgres -d postgres -c "SELECT name, includes_website_benefit, includes_tshirt FROM sponsorship_packages;"

# 4. Verify sponsor_uploads schema
psql -h localhost -U postgres -d postgres -c "\d sponsor_uploads"
```

---

## Rollback

```sql
-- If needed, rollback migration
DROP TABLE IF EXISTS sponsor_uploads CASCADE;

ALTER TABLE sponsorship_packages
DROP COLUMN IF EXISTS includes_website_benefit,
DROP COLUMN IF EXISTS includes_banner,
DROP COLUMN IF EXISTS includes_tshirt,
DROP COLUMN IF EXISTS includes_golf_sign,
DROP COLUMN IF EXISTS includes_game_day,
DROP COLUMN IF EXISTS description;
```

---

## Next Steps

After this plan completes:
- Plan 08-02: Google Drive & Sheets integration
- Plan 08-03: Setup validation script

---

*Plan created: 2026-01-23*
