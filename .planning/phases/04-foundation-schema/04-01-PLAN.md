---
phase: 04-foundation-schema
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/005_invoicing.sql
  - src/lib/stripe/client.ts
  - src/lib/supabase/types.ts
  - src/app/api/webhooks/stripe/route.ts
  - .env.local.example
  - package.json
autonomous: true

must_haves:
  truths:
    - "Database tables exist for sponsorship_packages, invoices, and webhook_events"
    - "Stripe SDK is installed and exports initialized client"
    - "Webhook endpoint accepts POST requests and verifies Stripe signatures"
    - "Sponsorship packages can be queried from database"
  artifacts:
    - path: "supabase/migrations/005_invoicing.sql"
      provides: "Schema for invoicing system"
      contains: "CREATE TABLE sponsorship_packages"
    - path: "src/lib/stripe/client.ts"
      provides: "Stripe SDK initialization"
      exports: ["stripe"]
    - path: "src/app/api/webhooks/stripe/route.ts"
      provides: "Webhook endpoint"
      exports: ["POST"]
    - path: "src/lib/supabase/types.ts"
      provides: "TypeScript types for new tables"
      contains: "sponsorship_packages"
  key_links:
    - from: "src/app/api/webhooks/stripe/route.ts"
      to: "src/lib/stripe/client.ts"
      via: "import stripe"
      pattern: "import.*stripe.*from.*@/lib/stripe"
    - from: "src/app/api/webhooks/stripe/route.ts"
      to: "src/lib/supabase/server.ts"
      via: "import createClient"
      pattern: "import.*createClient.*from.*@/lib/supabase"
---

<objective>
Create the database foundation and Stripe integration for sponsorship invoice management.

Purpose: Establishes the data layer (schema, types) and external integration (Stripe SDK, webhook endpoint) that all subsequent invoice features depend on. Without this foundation, Phase 5-7 cannot function.

Output:
- Database migration with 3 tables + atomic slot decrement function
- Stripe SDK configured and ready for invoice operations
- Webhook endpoint skeleton for payment detection
- TypeScript types for type-safe database access
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase research (patterns and schema design)
@.planning/phases/04-foundation-schema/04-RESEARCH.md
@.planning/phases/04-foundation-schema/04-CONTEXT.md

# Existing patterns to follow
@supabase/migrations/001_sponsors.sql
@src/lib/supabase/client.ts
@src/lib/supabase/server.ts
@src/lib/supabase/types.ts
@.env.local.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create database migration for invoicing system</name>
  <files>supabase/migrations/005_invoicing.sql</files>
  <action>
Create migration file following existing patterns from 001_sponsors.sql.

**Tables to create:**

1. `sponsorship_packages` table:
   - id (UUID, primary key)
   - name (TEXT, not null) - package description
   - cost (INTEGER, not null) - amount in cents, CHECK > 0
   - closing_date (DATE, nullable) - NULL for year-round packages
   - total_slots (INTEGER, not null) - original slot count
   - available_slots (INTEGER, not null) - current available, CHECK >= 0 and <= total_slots
   - created_at, updated_at (TIMESTAMPTZ)
   - Index on closing_date for availability queries

2. `invoices` table:
   - id (UUID, primary key)
   - stripe_invoice_id (TEXT, unique, not null) - Stripe's invoice ID
   - package_id (UUID, references sponsorship_packages ON DELETE RESTRICT)
   - package_name (TEXT, not null) - snapshot at creation
   - package_cost (INTEGER, not null) - snapshot at creation
   - customer_email (TEXT, not null)
   - customer_name (TEXT, not null)
   - status (TEXT, CHECK IN draft/open/paid/void/uncollectible, default 'draft')
   - created_at, finalized_at, paid_at, voided_at (TIMESTAMPTZ)
   - created_by (UUID, references auth.users)
   - Indexes on stripe_invoice_id, status, package_id, customer_email

3. `webhook_events` table:
   - id (UUID, primary key)
   - stripe_event_id (TEXT, unique, not null) - idempotency key
   - event_type (TEXT, not null)
   - processed_at (TIMESTAMPTZ, default NOW())
   - payload (JSONB, not null)
   - Indexes on stripe_event_id, event_type

**RLS Policies:**
- sponsorship_packages: Anyone can SELECT (public page), authenticated can INSERT/UPDATE/DELETE
- invoices: Authenticated can SELECT/INSERT/UPDATE (no DELETE - void instead)
- webhook_events: Authenticated can SELECT, service_role can INSERT

**Functions:**
- `decrement_package_slots(package_uuid UUID)` - atomic slot decrement, returns new slot count, raises exception if no slots available

**Seed data (4 packages from CONTEXT.md):**
- T-shirt bundle: $3,500 (350000 cents), July 31 2026, 18 slots
- Website logo: $600 (60000 cents), NULL closing_date (year-round), 15 slots
- Game day: $750 (75000 cents), July 31 2026, 13 slots
- Academy t-shirt: $500 (50000 cents), February 18 2026, 18 slots

**Trigger:**
- Reuse existing `update_updated_at_column()` function for sponsorship_packages
  </action>
  <verify>
Run `supabase db push` or review migration file structure matches 001_sponsors.sql pattern. Verify:
- All 3 tables have CREATE TABLE statements
- All RLS policies are defined
- All indexes are created
- decrement_package_slots function exists
- Seed data is included
  </verify>
  <done>
Migration file exists at supabase/migrations/005_invoicing.sql with 3 tables, RLS policies, indexes, atomic decrement function, and 4 seeded packages.
  </done>
</task>

<task type="auto">
  <name>Task 2: Install Stripe SDK and create TypeScript infrastructure</name>
  <files>
    - package.json
    - src/lib/stripe/client.ts
    - src/lib/supabase/types.ts
    - .env.local.example
  </files>
  <action>
**1. Install Stripe SDK:**
```bash
npm install stripe
```

**2. Create src/lib/stripe/client.ts:**
Following pattern from supabase/client.ts - simple initialization with environment validation.

```typescript
import Stripe from 'stripe';

if (!process.env.STRIPE_SECRET_KEY) {
  throw new Error('Missing STRIPE_SECRET_KEY environment variable');
}

export const stripe = new Stripe(process.env.STRIPE_SECRET_KEY, {
  apiVersion: '2025-02-24.acacia',
  typescript: true,
});
```

**3. Update src/lib/supabase/types.ts:**
Add type definitions for the 3 new tables following existing pattern:
- sponsorship_packages (Row, Insert, Update)
- invoices (Row, Insert, Update)
- webhook_events (Row, Insert, Update)

Include proper status unions and relationship definitions.

**4. Update .env.local.example:**
Add Stripe section with:
- STRIPE_SECRET_KEY (server-side only, sk_test_...)
- NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY (client-safe, pk_test_...)
- STRIPE_WEBHOOK_SECRET (whsec_...)

Include comments with links to Stripe Dashboard locations.
  </action>
  <verify>
- `npm install` completes without errors
- `npx tsc --noEmit` passes (types are valid)
- package.json includes "stripe" in dependencies
- src/lib/stripe/client.ts exports `stripe`
- src/lib/supabase/types.ts includes sponsorship_packages, invoices, webhook_events tables
- .env.local.example includes Stripe section
  </verify>
  <done>
Stripe SDK installed, client initialization file created, TypeScript types updated with 3 new tables, and .env.local.example updated with Stripe configuration section.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Stripe webhook endpoint</name>
  <files>src/app/api/webhooks/stripe/route.ts</files>
  <action>
Create webhook endpoint following App Router pattern (this is the first API route in the project).

**Endpoint requirements:**
- POST handler only (webhooks are POST)
- Use `await req.text()` for raw body (NOT req.json() - signature verification needs raw body)
- Get signature from `headers().get('stripe-signature')`
- Verify signature using `stripe.webhooks.constructEvent()`
- Check webhook_events table for idempotency before processing
- Return 200 for success, 400 for signature errors

**Structure:**
```typescript
import { headers } from 'next/headers';
import { stripe } from '@/lib/stripe/client';
import { createClient } from '@/lib/supabase/server';
import type Stripe from 'stripe';

export async function POST(req: Request) {
  // 1. Get raw body and signature
  // 2. Verify signature with constructEvent
  // 3. Check idempotency (webhook_events table)
  // 4. Handle known event types (skeleton - TODO comments for Phase 7)
  // 5. Record event in webhook_events
  // 6. Return 200
}
```

**Event handling (skeleton for Phase 7):**
- invoice.paid: TODO comment for status update + slot decrement
- invoice.finalized: TODO comment for status update
- invoice.voided: TODO comment for status update

Do NOT implement full event handling - that's Phase 7. This task creates the verified endpoint skeleton.
  </action>
  <verify>
- File exists at src/app/api/webhooks/stripe/route.ts
- Exports POST function
- Imports stripe from @/lib/stripe/client
- Uses req.text() (not req.json())
- Includes signature verification try/catch
- Includes idempotency check against webhook_events table
- Returns Response objects (200 or 400)
  </verify>
  <done>
Webhook endpoint exists and can receive Stripe webhooks, verify signatures, check idempotency, and return appropriate responses. Event handling logic is stubbed with TODO comments for Phase 7.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Migration file check:**
   - File exists at supabase/migrations/005_invoicing.sql
   - Contains CREATE TABLE for all 3 tables
   - Contains RLS policies
   - Contains decrement_package_slots function

2. **TypeScript compilation:**
   - Run `npx tsc --noEmit` - should pass with no errors

3. **Stripe client check:**
   - src/lib/stripe/client.ts exports `stripe` constant
   - Environment validation throws if STRIPE_SECRET_KEY missing

4. **Webhook endpoint check:**
   - src/app/api/webhooks/stripe/route.ts exists
   - Exports POST handler
   - Uses correct signature verification pattern
</verification>

<success_criteria>
Phase 4 success criteria satisfied:

1. Database tables exist for invoices, sponsorship tiers, and webhook event tracking
   - SATISFIED: 005_invoicing.sql creates sponsorship_packages, invoices, webhook_events

2. Stripe SDK is installed and initialized with proper environment variables
   - SATISFIED: stripe package installed, client.ts initializes with STRIPE_SECRET_KEY

3. Sponsorship tier configuration can be stored and retrieved from database
   - SATISFIED: sponsorship_packages table with seed data, TypeScript types defined

4. Webhook endpoint exists and can verify Stripe signatures
   - SATISFIED: src/app/api/webhooks/stripe/route.ts with constructEvent verification
</success_criteria>

<output>
After completion, create `.planning/phases/04-foundation-schema/04-01-SUMMARY.md` using the summary template.

Include:
- Files created/modified
- New exports (stripe client, POST handler)
- Environment variables added
- Database tables/functions created
- Any decisions made during implementation
</output>
