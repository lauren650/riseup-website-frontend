---
phase: 02-interactive-features
plan: 03
type: execute
wave: 2
depends_on: ["02-02"]
files_modified:
  - src/middleware.ts
  - src/app/(admin)/layout.tsx
  - src/app/(admin)/login/page.tsx
  - src/app/(admin)/dashboard/page.tsx
  - src/app/(admin)/dashboard/sponsors/page.tsx
  - src/lib/actions/sponsors.ts
  - src/app/(public)/partners/page.tsx
  - src/components/sponsors/sponsor-grid.tsx
autonomous: false
user_setup:
  - service: supabase
    why: "Admin user must exist for login to work"
    dashboard_config:
      - task: "Create admin user in Supabase Auth"
        location: "Supabase Dashboard -> Authentication -> Users -> Add user"

must_haves:
  truths:
    - "Admin can log in via protected login page"
    - "Unauthenticated users are redirected to login when accessing /admin/*"
    - "Admin can view list of pending sponsor submissions"
    - "Admin can approve a sponsor with one click"
    - "Approved sponsor logo appears on Partners page automatically"
    - "Partners page shows dynamic sponsor logos from database"
  artifacts:
    - path: "src/middleware.ts"
      provides: "Route protection for admin paths"
      contains: "/admin"
    - path: "src/app/(admin)/layout.tsx"
      provides: "Admin layout wrapper"
      exports: ["default"]
    - path: "src/app/(admin)/login/page.tsx"
      provides: "Admin login page"
      exports: ["default"]
    - path: "src/app/(admin)/dashboard/page.tsx"
      provides: "Admin dashboard home"
      exports: ["default"]
    - path: "src/app/(admin)/dashboard/sponsors/page.tsx"
      provides: "Sponsor approval interface"
      exports: ["default"]
    - path: "src/components/sponsors/sponsor-grid.tsx"
      provides: "Dynamic sponsor logo grid"
      exports: ["SponsorGrid"]
    - path: "src/app/(public)/partners/page.tsx"
      provides: "Partners page with dynamic sponsors and submission form"
      contains: "SponsorGrid"
  key_links:
    - from: "src/middleware.ts"
      to: "supabase.auth.getUser()"
      via: "auth check"
      pattern: "getUser"
    - from: "src/app/(admin)/dashboard/sponsors/page.tsx"
      to: "src/lib/actions/sponsors.ts"
      via: "approve action"
      pattern: "approveSponsor"
    - from: "src/components/sponsors/sponsor-grid.tsx"
      to: "supabase.from('sponsors')"
      via: "fetch approved sponsors"
      pattern: "from.*sponsors.*select"
---

<objective>
Build admin authentication, sponsor approval dashboard, and dynamic Partners page display.

Purpose: Enable administrators to review and approve sponsor submissions, which then automatically appear on the public Partners page. This fulfills requirements SPON-04 (admin approval) and SPON-05 (auto-display on Partners page).

Output: Protected admin panel with sponsor approval workflow and dynamic Partners page.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-interactive-features/02-RESEARCH.md
@.planning/phases/02-interactive-features/02-CONTEXT.md

Prior plan outputs needed:
@.planning/phases/02-interactive-features/02-02-SUMMARY.md (sponsors table, server action)

Existing patterns:
@src/lib/supabase/server.ts (server-side Supabase)
@src/lib/supabase/client.ts (client-side Supabase)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create auth middleware and admin layout</name>
  <files>src/middleware.ts, src/app/(admin)/layout.tsx, src/app/(admin)/login/page.tsx</files>
  <action>
Set up admin route protection:

1. src/middleware.ts:
   - Follow RESEARCH.md Pattern 4: Admin Route Protection
   - Create Supabase server client using @supabase/ssr createServerClient
   - Use getUser() (NOT getSession()) for security
   - Protect all /admin/* routes EXCEPT /admin/login
   - Redirect unauthenticated users to /admin/login
   - Redirect authenticated users from /admin/login to /admin/dashboard
   - Export config.matcher to exclude static files

2. src/app/(admin)/layout.tsx:
   - Simple layout wrapper for admin pages
   - Dark admin theme consistent with site
   - Include logout button in header
   - Show current user email
   - No need for sidebar (simple dashboard)

3. src/app/(admin)/login/page.tsx:
   - Simple email/password login form
   - Use Supabase signInWithPassword
   - Show error messages for failed login
   - Redirect to /admin/dashboard on success
   - Match site styling (dark theme)

Note: Admin users are created manually in Supabase Dashboard (no self-registration).
  </action>
  <verify>
1. `npm run build` succeeds
2. Visit /admin/dashboard while logged out - redirects to /admin/login
3. After login - can access /admin/dashboard
  </verify>
  <done>
Middleware protects admin routes. Login page works with Supabase Auth. Admin layout provides consistent wrapper with logout functionality.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create admin dashboard and sponsor approval page</name>
  <files>src/app/(admin)/dashboard/page.tsx, src/app/(admin)/dashboard/sponsors/page.tsx, src/lib/actions/sponsors.ts</files>
  <action>
Build the admin interface:

1. src/app/(admin)/dashboard/page.tsx:
   - Simple overview page
   - Show count of pending sponsors
   - Link to /admin/dashboard/sponsors
   - Welcome message with admin email

2. src/app/(admin)/dashboard/sponsors/page.tsx:
   - List all sponsors (pending first, then approved)
   - Show: logo preview, company name, contact email, status, submitted date
   - Approve button for pending sponsors
   - Use server component to fetch data
   - Include approve action form

3. Add to src/lib/actions/sponsors.ts:
   - approveSponsor(sponsorId: string) server action
   - Update sponsor status to 'approved'
   - Set approved_at to now()
   - Set approved_by to current user ID
   - Move logo from pending/ to approved/ folder in storage (optional, can stay in pending/)
   - Revalidate /partners path
   - Return success/error

Simple table layout - no complex UI needed. Focus on functionality.
  </action>
  <verify>
1. `npm run build` succeeds
2. Admin can view list of sponsors at /admin/dashboard/sponsors
3. Clicking approve changes status in database
  </verify>
  <done>
Dashboard shows pending count. Sponsors page lists all submissions with approve functionality. Approval updates database and revalidates Partners page.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update Partners page with dynamic sponsors and submission form</name>
  <files>src/components/sponsors/sponsor-grid.tsx, src/app/(public)/partners/page.tsx</files>
  <action>
Make Partners page dynamic:

1. src/components/sponsors/sponsor-grid.tsx:
   - Async server component that fetches approved sponsors
   - Query: supabase.from('sponsors').select().eq('status', 'approved').order('company_name')
   - Render logos in responsive grid (2 cols mobile, 3 md, 4 lg)
   - Each logo: link to sponsor website (target="_blank"), uniform container size with object-contain
   - Show "No sponsors yet" message if empty
   - Use 200x120px containers (5:3 aspect ratio per CONTEXT.md)

2. Update src/app/(public)/partners/page.tsx:
   - Import and use SponsorGrid component in "Our Sponsors" section
   - Remove placeholder logos array
   - Import and add SponsorForm in "Become a Partner" section
   - Add text: "Already a partner? Submit your company information and logo:"
   - Keep sponsorship levels section as-is

Grid styling: rounded corners, hover effect (slight scale or opacity), consistent spacing.
  </action>
  <verify>
1. `npm run build` succeeds
2. Visit /partners - shows approved sponsors from database (or empty state)
3. Sponsor form is visible in Become a Partner section
4. Clicking sponsor logo opens their website
  </verify>
  <done>
Partners page dynamically displays approved sponsors. Sponsor form allows new submissions. Logos link to sponsor websites.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 4: Verify end-to-end sponsor submission flow</name>
  <what-built>
Complete sponsor submission and approval workflow:
- Sponsor submission form on Partners page
- Logo upload to Supabase Storage
- Admin login at /admin/login
- Sponsor approval dashboard at /admin/dashboard/sponsors
- Automatic display of approved sponsors on Partners page
  </what-built>
  <how-to-verify>
1. Visit http://localhost:3000/partners
2. Scroll to "Become a Partner" section
3. Fill out the sponsor form with test data:
   - Company Name: Test Company
   - Contact Name: Test User
   - Email: test@example.com
   - Phone: 555-123-4567
   - Website: https://example.com
   - Upload any image as logo
4. Submit form - should see success message
5. Visit http://localhost:3000/admin/login
6. Log in with admin credentials (created in Supabase Dashboard)
7. Navigate to Sponsors at /admin/dashboard/sponsors
8. Find "Test Company" in pending list
9. Click Approve button
10. Visit http://localhost:3000/partners
11. Verify Test Company logo now appears in sponsor grid
12. Click logo - should open https://example.com in new tab
  </how-to-verify>
  <resume-signal>Type "approved" if full flow works, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete, verify full flow:
1. `npm run build` succeeds
2. Sponsor submits form on /partners (creates pending record)
3. Admin logs in at /admin/login
4. Admin sees pending sponsor at /admin/dashboard/sponsors
5. Admin clicks Approve
6. Sponsor logo appears on /partners page
</verification>

<success_criteria>
- Admin routes protected by middleware
- Login works with Supabase Auth
- Admin can view and approve sponsors
- Approved sponsors display on Partners page automatically
- Sponsor form accessible on Partners page
- Full submission-to-display flow works end-to-end
</success_criteria>

<output>
After completion, create `.planning/phases/02-interactive-features/02-03-SUMMARY.md`
</output>
